<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Updated viewport meta tag with viewport-fit -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Zheng Shangyou</title>
    <!-- Google Fonts for a more elegant typography -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto+Slab:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Existing CSS styles... */

        /* Specific Styling for Red Joker */
        .card-btn.red-joker {
            border: 2px solid red; /* Default red border */
        }

        .card-btn.red-joker.selected {
            border: 3px solid lightblue; /* Light blue border when selected */
            box-shadow: 0 0 15px lightblue;
        }

        /* Specific Styling for Black Joker */
        /* .card-btn.black-joker {
            border: 2px solid black; 
        }

        .card-btn.black-joker.selected {
            border: 3px solid lightblue; 
            box-shadow: 0 0 15px lightblue;
        } */

        /* General Styling for Other Cards */
        .card-btn.selected {
            border: 3px solid lightblue; /* Existing red border for selected non-joker cards */
            box-shadow: 0 0 15px lightblue;
        }

        /* Rest of your existing CSS... */

        /* Optional: Add styles for disabled buttons */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Example styles for error message */
        #error-message {
            display: none;
            color: red;
            margin-top: 10px;
        }

        #error-message.show {
            display: block;
        }

        /* Import Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto+Slab:wght@400;700&display=swap');

        /* Reset some default styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Body Styling */
        body {
            font-family: 'Montserrat', sans-serif;
            background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');
            /* Subtle texture */
            background-size: cover;
            /* Ensure background covers entire screen */
            background-color: #2e2e2e;
            color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            /* Prevent horizontal scrolling */
        }

        /* Overlay for semi-transparent background with safe area insets */
        .overlay {
            background: rgba(0, 0, 0, 0.8);
            padding: calc(30px + env(safe-area-inset-top)) calc(30px + env(safe-area-inset-right)) calc(30px + env(safe-area-inset-bottom)) calc(30px + env(safe-area-inset-left));
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            /* For the info-icon positioning */
        }

        /* ICON BUTTON (top-right corner) */
        .info-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 30px;
            height: 30px;
            background-color: #8888884a;
            /* Grey background */
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);

            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;

            margin: 0; /* Reset any external margins */
    padding: 0; /* Reset any padding */
        }

        .info-icon:hover {
            background-color: #bebebeba;
            /* Darker grey on hover */
            transform: translateY(-2px);
        }

        /* Responsive positioning for the icon so it doesn't overlap the title */
        @media screen and (max-width: 400px) {
            .info-icon {
                top: 10px;
                right: 10px;
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
        }

        /* MODAL (hidden by default) */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* MODAL CONTENT */
        .modal-content {
            background-color: #3e3e3e;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* CLOSE BUTTON FOR MODAL */
        .close {
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #ccc;
        }

        /* Title Styling */
        .title {
            font-family: 'Roboto Slab', serif;
            font-size: 2rem;
            color: #ffd700;
            /* Gold color */
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
        }

        /* Card Styling for Containers */
        .card {
            background-color: #3e3e3e;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Headings */
        h1,
        h2,
        h3 {
            font-family: 'Roboto Slab', serif;
            color: #ffd700;
            text-shadow: 1px 1px 3px #000;
        }

        h1.title {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Input Fields */
        #room-container input,
        #game-board input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 1rem;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #2e2e2e;
            color: #f5f5f5;
            outline: none;
            text-align: center;
        }

        #room-container input::placeholder,
        #game-board input::placeholder {
            color: #bbb;
        }

        /* Buttons */
        button {
            font-family: 'Montserrat', sans-serif;
            min-width: 44px;
            min-height: 44px;
            padding: 0.75em 1.5em;
            margin: 10px 5px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #join-room-button {
            background-color: #ffd700;
            color: #000000;
            display: block;
            /* Makes the button a block element */
            margin: 0 auto;
            /* Horizontally centers it within its container */
        }

        #join-room-button:hover {
            background-color: #c4a708;
            transform: translateY(-2px);
        }

        #start-game-button {
            background-color: #ffc107;
            color: #000000;
            display: block;
            margin: 20px auto 0 auto;
        }

        #start-game-button:hover {
            background-color: #be9006;
            transform: translateY(-2px);
        }

        #start-game-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #send-button {
            background-color: #00bb42;
            /* Greenish */
            color: #ffffff;
        }

        #send-button:hover {
            background-color: #007d2c;
            transform: translateY(-2px);
        }

        #send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #pass-button {
            background-color: #ff0707;
            color: #feffff;
        }

        #pass-button:hover {
            background-color: #a50000;
            transform: translateY(-2px);
        }

        #pass-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #exit-room {
            background-color: #dc3545;
            /* Red */
            color: #fff;
        }

        #exit-room:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Players List */
        .players-list {
            background-color: #4e4e4e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .players-list p {
            font-size: 1rem;
            color: #f5f5f5;
            margin: 5px 0;
            text-shadow: 1px 1px 2px #000;
        }

        /* Hand Styling */
        .hand {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .card-btn {
            width: 60px;
            height: 90px;
            margin: 5px;
            background-color: #2e2e2e;
            border: 2px solid #ffd700;
            border-radius: 5px;
            color: #f5f5f5;
            font-size: 0.875rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            background-image: url('https://www.transparenttextures.com/patterns/card-texture.png');
            background-size: cover;
            position: relative;

            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;

            word-wrap: break-word;
            white-space: normal;
            padding: 5px;
        }

        .card-btn:hover {
            transform: scale(1.05);
            background-color: #3e3e3e;
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.5);
        }

        /* Specific Styling for Red Joker */
        .card-btn.red-joker {
            border: 2px solid red; /* Default red border */
        }

        .card-btn.red-joker.selected {
            border: 3px solid lightblue; /* Light blue border when selected */
            box-shadow: 0 0 15px lightblue;
        }

        /* Specific Styling for Black Joker */
        .card-btn.black-joker {
            border: 2px solid rgb(161, 161, 161); /* Default black border */
        }

        .card-btn.black-joker.selected {
            border: 3px solid lightblue; /* Light blue border when selected */
            box-shadow: 0 0 15px lightblue;
        }

        /* General Styling for Other Cards */
        .card-btn.selected {
            border: 3px solid lightblue; /* Existing red border for selected non-joker cards */
            box-shadow: 0 0 15px lightblue;
        }

        /* Action Buttons Container */
        #action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* Played Cards Section */
        .played-cards {
            background-color: #4e4e4e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 50px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .played-cards p {
            font-size: 1rem;
            color: #f5f5f5;
            margin: 5px 0;
            text-shadow: 1px 1px 2px #000;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Game Info Section */
        .game-info {
            background-color: #4e4e4e;
            padding: 15px;
            border-radius: 8px;
        }

        .game-info h2 {
            font-size: 1.6rem;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .game-info ol {
            list-style: decimal inside;
            color: #f5f5f5;
        }

        .game-info li {
            margin: 5px 0;
            text-shadow: 1px 1px 2px #000;
        }

        /* Turn Display */
        .turn-display {
            background-color: #5a5a5a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 1.125rem;
            color: #ffd700;
            text-shadow: 1px 1px 2px #000;
        }

        /* Order Display */
        .order-display {
            font-size: 1rem;
            color: #f5f5f5;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px #000;
        }

        /* Error Message Styling */
        #error-message {
            margin-top: 20px;
            font-size: 1rem;
            background-color: #721c24;
            border: 1px solid #f5c6cb;
            color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #error-message.show {
            display: block;
            opacity: 1;
        }

        /* Game Container Styling */
        .game-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
        }

        #game-board {
            flex: 3;
            max-width: 70%;
        }

        #right-panel {
            flex: 1;
            max-width: 30%;
        }

        /* Responsive Adjustments */
        @media screen and (max-width: 1200px) {
            .game-container {
                flex-direction: column;
                align-items: center;
            }

            #game-board,
            #right-panel {
                max-width: 100%;
            }
        }

        @media screen and (max-width: 768px) {
            .overlay {
                padding: calc(20px + env(safe-area-inset-top)) calc(20px + env(safe-area-inset-right)) calc(20px + env(safe-area-inset-bottom)) calc(20px + env(safe-area-inset-left));
            }

            .title {
                font-size: 1.8rem;
            }

            .card {
                max-width: 90%;
            }

            .game-container {
                flex-direction: column;
                align-items: center;
            }

            #game-board,
            #right-panel {
                max-width: 100%;
            }

            .hand {
                justify-content: center;
            }

            .card-btn {
                width: 50px;
                height: 75px;
                font-size: 0.875rem;
            }

            button {
                padding: 0.5em 1em;
                font-size: 0.875rem;
            }

            .turn-display {
                font-size: 1rem;
            }

            .game-info h2 {
                font-size: 1.4rem;
            }

            .game-info li {
                font-size: 0.875rem;
            }
        }

        @media screen and (max-width: 480px) {
            .title {
                font-size: 1.6rem;
            }

            .card {
                padding: 15px;
            }

            .game-container {
                flex-direction: column;
                align-items: center;
            }

            #game-board,
            #right-panel {
                max-width: 100%;
            }

            .hand {
                flex-direction: column;
                align-items: center;
            }

            .card-btn {
                width: 40px;
                height: 60px;
                font-size: 0.75rem;
            }

            button {
                padding: 0.5em 1em;
                font-size: 0.75rem;
            }

            .turn-display {
                font-size: 0.875rem;
            }

            .game-info h2 {
                font-size: 1.2rem;
            }

            .game-info li {
                font-size: 0.75rem;
            }
        }

        /* Footer Styling */
        .footer {
            font-size: 0.875rem;
            color: #bbb;
            margin-top: 15px;
            text-align: center;
        }

        /* Played Card Styling */
        .played-card {
            width: 40px;
            height: 60px;
            margin: 5px;
            background-color: #2e2e2e;
            border: 2px solid #444;
            border-radius: 5px;
            color: #f5f5f5;
            font-size: 0.75rem;
            cursor: default;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            background-image: url('https://www.transparenttextures.com/patterns/card-texture.png');
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            word-wrap: break-word;
            white-space: normal;
            padding: 5px;
        }

        .played-card:hover {
            transform: scale(1.05);
            background-color: #3e3e3e;
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.5);
        }

        /* About Section in the modal */
        .about-section h2 {
            font-family: 'Roboto Slab', serif;
            color: #ffd700;
            text-shadow: 1px 1px 3px #000;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .about-section p,
        .about-section li {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 10px;
            color: #f5f5f5;
        }

        .about-section ul {
            list-style: disc inside;
        }
    </style>
</head>

<body>
    <!-- Modal for About Section -->
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAboutModal()">&times;</span>
            <div class="about-section">
                <h2>About “Zheng Shangyou”</h2>
                <p>
                    <strong>Zheng Shangyou</strong> (争上游), also known as "Fight the Landlord's Cousin" in some regions,
                    is a captivating card game that emphasizes strategy, quick decision-making, and timely teamwork
                    (when multiple players are involved).
                </p>
                <p>
                    The name "争上游" translates roughly to "strive to be on top," reflecting the competitive nature of the
                    game as players race to deplete their hand before anyone else.
                </p>
                <h3>How to Play</h3>
                <ul>
                    <li>Players join a virtual room and each is dealt a hand of cards.</li>
                    <li>On your turn, you can either play a valid combination of cards (single, pairs, bombs, straights,
                        etc.) or choose to pass if you cannot or do not wish to play.</li>
                    <li>When a player finishes all their cards, the game ends and the rankings are announced based on
                        the order in which players run out of cards.</li>
                </ul>
                <h3>Key Rules</h3>
                <ul>
                    <li><strong>Valid Plays:</strong> Singles, pairs, bombs (3 or 4 of a kind), straights, and special
                        joker or “4” combos are all part of the fun.</li>
                    <li><strong>Bombs Beat Everything:</strong> A bomb can beat any lower combination, but beware of
                        special combos like joker pairs or “4” sets that can trump bombs.</li>
                    <li><strong>Joker Power:</strong> A pair of Jokers beats any other combination (even bombs), except
                        for the cases specially defined in the rules (like ultra bombs of higher rank).</li>
                </ul>
                <p>
                    In essence, always keep an eye out for powerful combos that can shift the course of the game.
                    Anticipate your opponents’ moves, manage your hand carefully, and strive to be the first to play all
                    your cards.
                </p>
                <p>
                    Need more details? <a href="rules.html" target="_blank" style="color: #ffd700; text-decoration: underline;">View more rules here</a>.
                </p>
            </div>
        </div>
    </div>


    <div class="overlay">
        <!-- <h1 class="title">Zheng Shangyou 争上游</h1> -->
        <!-- Icon Button (top-right) - Grey circle -->
        <button class="info-icon" onclick="openAboutModal()">ℹ</button>


        <div id="room-container" class="card">
            <h2>Join a Room（加入房间）</h2>
            <p>Enter Room Name:</p>
            <input type="text" id="room-name" placeholder="Room Name（房间号）">
            <p>Enter Your Name:</p>
            <input type="text" id="player-name" placeholder="Your Name（名字）">
            <!-- Added aria-label for accessibility -->
            <button id="join-room-button" onclick="joinRoom()" aria-label="Join Room">Proceed!</button>
            <!-- Footer Footnote -->
            <p class="footer">© Frederick Liu. All rights reserved.</p>
        </div>

        <!-- Game Container for Flex Layout -->
        <div class="game-container">
            <div id="game-board" class="card" style="display:none;">
                <h2>Room: <span id="room-display"></span></h2>
                <div id="players" class="players-list"></div>
                <div id="order-display" class="order-display"></div>
                <div id="turn-display" class="turn-display"></div>
                <button id="start-game-button" onclick="readyToStart()" style="display:none;" disabled
                    aria-label="Start Game">Start Game（开始）</button>
                <div id="hand" class="hand"></div>
                <div id="action-buttons">
                    <button id="send-button" onclick="playTurn()" style="display:none;"
                        aria-label="Send Cards">Play（出牌）</button>
                    <button id="pass-button" onclick="passTurn()" style="display:none;"
                        aria-label="Pass Turn">Pass（不要）</button>
                    <button id="exit-room" onclick="exitRoom()" style="display:none;" aria-label="Exit Room">Exit
                        Room</button>
                </div>

                <!-- Error Message Display -->
                <div id="error-message">Error message will appear here.</div>
            </div>

            <div id="right-panel" class="card" style="display:none;">
                <h3>Game Info</h3>
                <div id="played-cards" class="played-cards"></div>
                <div id="game-info" class="game-info"></div>
            </div>
        </div>
    </div>

    <script>
        /* JavaScript logic is unchanged, except for the openAboutModal/closeAboutModal that toggles the modal display. */
        let socket;
        let currentRoom = null;
        let playerName = null;
        let nextCardIndex = 0;
        let isPlayerTurn = false;
        let previousPlay = null;
        const cardRankings = ['4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2', '3', 'Black Joker', 'Red Joker'];

        /* MODAL FUNCTIONS */
        function openAboutModal() {
            document.getElementById('about-modal').style.display = 'block';
        }
        function closeAboutModal() {
            document.getElementById('about-modal').style.display = 'none';
        }

        function joinRoom() {
            const roomName = document.getElementById('room-name').value.trim();
            playerName = document.getElementById('player-name').value.trim();
            if (roomName && playerName) {
                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const hostname = window.location.hostname;
                const port = window.location.port || (window.location.protocol === 'https:' ? 443 : 80);
                const socketURL = `${protocol}${hostname}:${port}`;
                console.log('Connecting to WebSocket at:', socketURL); // For debugging
                socket = new WebSocket(socketURL);

                socket.onopen = () => {
                    socket.send(JSON.stringify({ type: 'join', room: roomName, playerName }));
                    document.getElementById('join-room-button').disabled = true;
                };
                socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleServerMessage(message);
                };
                currentRoom = roomName;
            } else {
                alert('Please enter a room name and your name.');
            }
        }

        function handleServerMessage(message) {
            switch (message.type) {
                case 'room_joined':
                    document.getElementById('room-container').style.display = 'none';
                    document.getElementById('game-board').style.display = 'block';
                    document.getElementById('right-panel').style.display = 'block';  // Show the right panel
                    document.getElementById('room-display').innerText = currentRoom;
                    renderPlayers(message.players);
                    document.getElementById('start-game-button').style.display = 'block';
                    if (message.players.length >= 2) {
                        document.getElementById('start-game-button').disabled = false;
                    }
                    break;
                case 'start_game':
                    distributeCards(message.deck);
                    renderOrder(message.order);
                    updateTurnDisplay(message.currentPlayer);
                    break;
                case 'player_move':
                    previousPlay = message.playedCards.length > 0 ? message.playedCards[message.playedCards.length - 1] : null;
                    updatePlayerCards(message.players);
                    displayPlayedCards(message.playedCards);
                    updateTurnDisplay(message.currentPlayer);
                    break;
                case 'update_cards':
                    updatePlayerCardCount(message.playerName, message.cardsLeft);
                    break;
                case 'game_over':
                    displayRankings(message.rankings);
                    break;
                case 'error':
                    // If the server sends "duplicate_name" or "room_full", show alert + error
                    if (message.message === 'duplicate_name') {
                        alert('This name is already taken in this room. Please use a different name.');
                        displayError('The name is already taken in this room. Please use a different name.');
                        document.getElementById('join-room-button').disabled = false;
                    }
                    else if (message.message === 'room_full') {
                        alert('The room is full. Please try a different room.');
                        displayError('The room is full. Please try a different room.');
                        document.getElementById('join-room-button').disabled = false;
                    }
                    else {
                        displayError(message.message);
                    }
                    break;
                case 'player_left':
                    alert(message.message);
                    exitRoom();
                    break;
                default:
                    console.warn("Unhandled message type:", message.type);
            }
        }

        function displayError(message) {
            console.log("Error function triggered:", message);
            const errorMessage = document.getElementById('error-message');
            errorMessage.innerText = message;
            errorMessage.classList.add('show');
            // Optionally hide it after some time
            setTimeout(() => {
                errorMessage.classList.remove('show');
                errorMessage.innerText = '';
            }, 3000);
        }

        function renderPlayers(players) {
            document.getElementById('players').innerHTML = players.map(player =>
                `<p>${player.name} - Cards Left (牌数): <span id="card-count-${player.name}">${player.hand.length}</span> ${player.finished ? '(Finished)' : ''}</p>`
            ).join('');
            if (players.length >= 2) {
                document.getElementById('start-game-button').disabled = false;
            }
        }

        function renderOrder(order) {
            document.getElementById('order-display').innerHTML = `<p>Turn Order（出牌顺序）: ${order.join(', ')}</p>`;
        }

        function updateTurnDisplay(currentPlayer) {
            document.getElementById('turn-display').innerHTML = `<p>Current Turn（当前回合）: ${currentPlayer}</p>`;
            isPlayerTurn = currentPlayer === playerName;

            // Enable or disable card selection, Send, and Pass buttons based on whether it's the player's turn
            if (isPlayerTurn) {
                document.getElementById('send-button').disabled = false;
                document.getElementById('pass-button').disabled = false;
                enableCardSelection(true);
            } else {
                document.getElementById('send-button').disabled = true;
                document.getElementById('pass-button').disabled = true;
                enableCardSelection(false);
            }
        }

        function readyToStart() {
            socket.send(JSON.stringify({ type: 'ready', room: currentRoom }));
            document.getElementById('start-game-button').disabled = true;
        }

        function distributeCards(deck) {
            const sortedDeck = deck.sort((a, b) => rankToValue(a.value) - rankToValue(b.value));
            document.getElementById('hand').innerHTML = sortedDeck.map((card, index) => {
                let jokerClass = '';
                if (card.value === 'Red Joker') {
                    jokerClass = ' red-joker';
                } else if (card.value === 'Black Joker') {
                    jokerClass = ' black-joker';
                }
                return `<button class="card-btn${jokerClass}" onclick="selectCard(${index})" id="card-${index}" disabled>${card.value}</button>`;
            }).join('');
            document.getElementById('send-button').style.display = 'block';
            document.getElementById('pass-button').style.display = 'block';
        }

        function selectCard(uniqueId) {
            if (!isPlayerTurn) return;
            const cardButton = document.getElementById(`card-${uniqueId}`);
            if (cardButton) {
                cardButton.classList.toggle('selected');
            }
        }

        function playTurn() {
            if (!isPlayerTurn) return;
            const selectedCards = Array.from(document.getElementsByClassName('selected')).map(button => button.innerText);
            const playType = determinePlayType(selectedCards);

            if (!validatePlay(selectedCards, playType)) {
                displayError("Invalid play based on the game rules.");
                return;
            }

            if (selectedCards.length > 0) {
                socket.send(JSON.stringify({ type: 'play_turn', room: currentRoom, cards: selectedCards }));
                removePlayedCards(selectedCards);
            }
        }

        function determinePlayType(cards) {
            if (isPair(cards)) {
                return 'Pair';
            } else if (isRegularBomb(cards)) {
                return 'Regular Bomb';
            } else if (isUltraBomb(cards)) {
                return 'Ultra Bomb';
            } else if (isStraight(cards)) {
                return 'Straight';
            } else if (cards.length === 1) {
                return 'Single';
            }
            return 'Other';
        }

        function validatePlay(cards, playType) {
            if (playType === 'Other') {
                return false;
            }

            if (!previousPlay) {
                return true; // No previous play to compare with
            }

            if (isPairOfJokers(cards)) {
                return true; // Two Jokers beats any previous play
            }



            if (playType === 'Pair' && !isPair(cards)) {
                return false;
            }
            if (playType === 'Regular Bomb' && !isRegularBomb(cards)) {
                return false;
            }
            if (playType === 'Ultra Bomb' && !isUltraBomb(cards)) {
                return false;
            }

            const previousPlayType = determinePlayType(previousPlay.cards);

            // If the previous play was a pair of Jokers, nothing can beat it
            if (isPairOfJokers(previousPlay.cards)) {
                return false;
            }
            // -----------------------------------------------------------
            // NEW LOGIC: 3-of-a-kind cannot beat a single Joker,
            //            but 4-of-a-kind CAN beat a single Joker
            // -----------------------------------------------------------
            if (
                previousPlayType === 'Single' &&
                (previousPlay.cards[0] === 'Black Joker' || previousPlay.cards[0] === 'Red Joker')
            ) {
                // If this new play is a 3-of-a-kind (regular bomb), reject
                if (isRegularBomb(cards)) {
                    return false;
                }
                // If it's a 4-of-a-kind (ultra bomb), allow
                if (isUltraBomb(cards)) {
                    return true;
                }
            }

            // New Rule: single vs. pair
            if (previousPlayType === 'Single' && playType === 'Pair' && !isPairOfJokers(cards)) {
                return false;
            }

            // Ultra Bomb escalation
            if (previousPlayType === 'Ultra Bomb') {
                if (playType !== 'Ultra Bomb' && !isThreeOfFours(cards)) {
                    return false;
                }
                if (playType === 'Ultra Bomb' && rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                    return false;
                }
                if (isThreeOfFours(cards)) {
                    collectBomb(previousPlay.cards, 'Ultra Bomb');
                }
            }

            // Regular Bomb escalation
            if (previousPlayType === 'Regular Bomb') {
                if (playType !== 'Regular Bomb' && playType !== 'Ultra Bomb' && !isPairOfFours(cards)) {
                    return false;
                }
                if (playType === 'Regular Bomb' && rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                    return false;
                }
                if (isPairOfFours(cards)) {
                    collectBomb(previousPlay.cards, 'Regular Bomb');
                }
            }

            // Pair escalation
            if (previousPlayType === 'Pair') {
                if (playType !== 'Pair' && playType !== 'Regular Bomb' && playType !== 'Ultra Bomb' && !isPairOfJokers(cards)) {
                    return false;
                }
                if (playType === 'Pair' && rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                    return false;
                }
            }

            // Straight escalation
            if (previousPlayType === 'Straight') {
                if (isPairSet(previousPlay.cards)) {
                    if (
                        (playType !== 'Straight' && playType !== 'Ultra Bomb' && !isPairOfJokers(cards)) ||
                        (playType === 'Straight' && !isPairSet(cards))
                    ) {
                        return false;
                    }
                    if (playType === 'Straight') {
                        const pLen = previousPlay.cards.length;
                        const cLen = cards.length;
                        if (cLen !== pLen || rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                            return false;
                        }
                    }
                } else if (isRegularBombSet(previousPlay.cards)) {
                    if (playType !== 'Regular Bomb' && playType !== 'Ultra Bomb' && !isPairOfJokers(cards)) {
                        return false;
                    }
                    if (playType === 'Regular Bomb' && rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                        return false;
                    }
                } else if (isUltraBombSet(previousPlay.cards)) {
                    if (playType !== 'Ultra Bomb' && !isPairOfJokers(cards)) {
                        return false;
                    }
                    if (playType === 'Ultra Bomb' && rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                        return false;
                    }
                } else {
                    if (playType !== 'Straight' && playType !== 'Regular Bomb' && playType !== 'Ultra Bomb' && !isPairOfJokers(cards)) {
                        return false;
                    }
                    if (playType === 'Straight') {
                        const pLen = previousPlay.cards.length;
                        if (cards.length !== pLen || rankToValue(cards[0]) <= rankToValue(previousPlay.cards[0])) {
                            return false;
                        }
                    }
                }
            }

            if (previousPlayType === 'Single' && playType === 'Single') {
                return rankToValue(cards[0]) > rankToValue(previousPlay.cards[0]);
            }

            // Collecting bombs
            if (playType === 'Regular Bomb' && previousPlayType === 'Ultra Bomb') {
                return rankToValue(cards[0]) === rankToValue('4');
            }
            if (playType === 'Pair' && previousPlayType === 'Regular Bomb') {
                return rankToValue(cards[0]) === rankToValue('4');
            }

            return true;
        }

        function isThreeOfFours(cards) {
            return cards.length === 3 && cards.every(card => card === '4');
        }

        function isPairOfFours(cards) {
            return cards.length === 2 && cards.every(card => card === '4');
        }

        function isPairSet(cards) {
            const groupCounts = Object.values(groupCardsByValue(cards));
            return groupCounts.every(count => count === 2);
        }

        function isRegularBombSet(cards) {
            const groupCounts = Object.values(groupCardsByValue(cards));
            return groupCounts.every(count => count === 3);
        }

        function isUltraBombSet(cards) {
            const groupCounts = Object.values(groupCardsByValue(cards));
            return groupCounts.every(count => count === 4);
        }

        function groupCardsByValue(cards) {
            const groupedCards = {};
            cards.forEach(card => {
                if (!groupedCards[card]) {
                    groupedCards[card] = 0;
                }
                groupedCards[card]++;
            });
            return groupedCards;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function collectBomb(bombCards, bombType) {
            console.log(`Collected a ${bombType}:`, bombCards);

            const handElement = document.getElementById('hand');

            bombCards.forEach(card => {
                const newCardButton = document.createElement('button');
                newCardButton.classList.add('card-btn');
                newCardButton.innerText = card;

                const uniqueId = generateUUID();
                newCardButton.id = `card-${uniqueId}`;

                newCardButton.onclick = function () {
                    selectCard(uniqueId);
                };

                handElement.appendChild(newCardButton);
            });

            const playerCardCount = handElement.children.length;
            document.getElementById(`card-count-${playerName}`).innerText = playerCardCount;

            socket.send(JSON.stringify({
                type: 'collect_bomb',
                room: currentRoom,
                playerName: playerName,
                bombCards: bombCards
            }));
        }

        function isPair(cards) {
            if (cards.length !== 2) {
                return false;
            }
            const [card1, card2] = cards;
            if (card1 === card2) {
                return true;
            }
            const isJokerPair = (card1 === 'Black Joker' && card2 === 'Red Joker') ||
                (card1 === 'Red Joker' && card2 === 'Black Joker');
            return isJokerPair;
        }

        function isRegularBomb(cards) {
            return cards.length === 3 && cards.every(card => card === cards[0]);
        }

        function isUltraBomb(cards) {
            return cards.length === 4 && cards.every(card => card === cards[0]);
        }

        function isStraight(cards) {
            if (cards.length < 3) return false;

            const groupedCards = {};
            cards.forEach(card => {
                if (!groupedCards[card]) {
                    groupedCards[card] = 0;
                }
                groupedCards[card]++;
            });

            const groupCounts = Object.values(groupedCards);
            const isPairSet = groupCounts.every(count => count === 2);
            const isRegularBombSet = groupCounts.every(count => count === 3);
            const isUltraBombSet = groupCounts.every(count => count === 4);

            if (!isPairSet && !isRegularBombSet && !isUltraBombSet) {
                const hasDuplicates = groupCounts.some(count => count > 1);
                if (hasDuplicates) {
                    return false;
                }
            }

            const sortedValues = Object.keys(groupedCards)
                .map(value => rankToValue(value))
                .sort((a, b) => a - b);

            for (let i = 1; i < sortedValues.length; i++) {
                if (sortedValues[i] !== sortedValues[i - 1] + 1) {
                    return false;
                }
            }

            if ((isPairSet || isRegularBombSet || isUltraBombSet) && sortedValues.length >= 3) {
                return true;
            }

            return sortedValues.length >= 3;
        }

        function isPairOfJokers(cards) {
            return cards.length === 2 && cards.includes('Red Joker') && cards.includes('Black Joker');
        }

        function rankToValue(rank) {
            return cardRankings.indexOf(rank);
        }

        function removePlayedCards(cards) {
            cards.forEach(card => {
                const cardButtons = Array.from(document.getElementsByClassName('card-btn'));
                const buttonsToRemove = cardButtons.filter(btn => btn.innerText.trim() === card.trim() && btn.classList.contains('selected'));
                buttonsToRemove.forEach(button => {
                    button.remove();
                });
            });
            const playerCardCount = document.getElementsByClassName('card-btn').length;
            document.getElementById(`card-count-${playerName}`).innerText = playerCardCount;
        }

        function updatePlayerCardCount(playerName, cardsLeft) {
            document.getElementById(`card-count-${playerName}`).innerText = cardsLeft;
        }

        function passTurn() {
            if (!isPlayerTurn) return;
            socket.send(JSON.stringify({ type: 'pass_turn', room: currentRoom }));
        }

        function enableCardSelection(enable) {
            const cardButtons = document.getElementsByClassName('card-btn');
            for (let button of cardButtons) {
                button.disabled = !enable;
            }
        }

        function updatePlayerCards(players) {
            players.forEach(player => {
                document.getElementById(`card-count-${player.name}`).innerText = player.hand.length;
            });
        }

        function displayPlayedCards(playedCards) {
            const playedCardsContainer = document.getElementById('played-cards');
            if (playedCards.length > 0) {
                playedCardsContainer.innerHTML = playedCards.map(play => {
                    const cardButtons = play.cards.map(card => {
                        return `<button class="played-card" disabled>${card}</button>`;
                    }).join('');
                    return `<p>${play.name} played（打了）: ${cardButtons}</p>`;
                }).join('');
            } else {
                playedCardsContainer.innerHTML = '<p>All players passed. You can play any valid combination of cards.</p>';
            }
        }

        function displayRankings(rankings) {
            document.getElementById('game-info').innerHTML = `<h2>Game Over! Rankings:</h2><ol>${rankings.map(name => `<li>${name}</li>`).join('')}</ol>`;
            document.getElementById('exit-room').style.display = 'block';
            disableOtherButtons();
        }

        function disableOtherButtons() {
            const buttonsToDisable = ['join-room-button', 'start-game-button', 'send-button', 'pass-button'];
            buttonsToDisable.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                }
            });
            const exitButton = document.getElementById('exit-room');
            if (exitButton) {
                exitButton.disabled = false;
            }
        }

        function enableButtonsAfterExit() {
            const buttonsToEnable = ['join-room-button', 'start-game-button', 'send-button', 'pass-button'];
            buttonsToEnable.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                }
            });
            const exitButton = document.getElementById('exit-room');
            if (exitButton) {
                exitButton.style.display = 'none';
                exitButton.disabled = true;
            }
        }

        function exitRoom() {
            socket.send(JSON.stringify({ type: 'leave', room: currentRoom }));
            socket.close();
            currentRoom = null;
            document.getElementById('game-board').style.display = 'none';
            document.getElementById('right-panel').style.display = 'none';
            document.getElementById('room-container').style.display = 'block';
            document.getElementById('game-info').innerHTML = '';
            document.getElementById('played-cards').innerHTML = '';
            document.getElementById('players').innerHTML = '';
            document.getElementById('room-name').value = '';
            document.getElementById('player-name').value = '';
            document.getElementById('exit-room').style.display = 'none';
            enableButtonsAfterExit();
        }

        window.onload = function () {
            document.getElementById('room-container').style.display = 'block';
            document.getElementById('game-board').style.display = 'none';
            document.getElementById('right-panel').style.display = 'none';
            document.getElementById('exit-room').disabled = true;
        };
    </script>
</body>

</html>
